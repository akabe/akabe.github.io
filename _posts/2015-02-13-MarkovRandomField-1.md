---
layout: post
title: "マルコフ確率場 (1)"
date: 2015-02-13
category: 機械学習
---

**確率的グラフィカルモデル** (probabilistic graphical model) は確率分布を表したグラフです
（ここで言う「グラフ」とは棒グラフや折れ線グラフとかのことではなく，ノードと辺で構成されるグラフのことです）．
確率変数の間の依存関係をわかりやすく可視化することで，
訓練アルゴリズムの設計や各種解析などに役立ちます．
画像のノイズ除去や自然言語処理などに応用されていて，機械学習では結構重要な位置付けです．
今回は，グラフィカルモデルの一種であるマルコフ確率場が私の修論に利用できそうなので，調べてみました．
この記事では，グラフィカルモデルの応用ではなく，基礎的な話を主に取り扱います．
数式たっぷりです．記事の内容を理解するためには，グラフと機械学習・確率論に関する基礎知識が必要です．

グラフィカルモデルでは，ノードは確率変数に対応し，辺は確率変数間の依存関係に相当します．
ここで言う依存関係とは，確率変数が独立か否かということです．
知っての通り，確率変数 $x$, $y$ が独立であるならば，$p(x,y) = p(x) p(y)$
というように，周辺確率 (marginal probability) を2つの確率の積に分解することができます．
グラフィカルモデルでは，独立ではない確率変数（ノード）間を辺で結ぶことで，
どの確率変数が依存しているのかを表現します（厳密には，ただの独立性ではなく，
条件付き独立性ですが，それについては後述します）．
しかし，「独立ではない」だけでは，情報が大雑把すぎて，あまり意味がないので，
もう少し具体的な依存関係を考えることが普通です．
グラフィカルモデルは次の2種類に大別されます．

- **ベイジアンネットワーク** (Bayesian network)：有向グラフ（辺が方向を持つグラフ）
で表現されるグラフィカルモデルで，「$x$ から $y$ への辺」は条件付き確率 (conditional probability)
$p(y | x)$ を表します．主に，確率変数間の因果関係を表現するのに向いているそうです．
- **マルコフ確率場** (Markov Random Field; MRF)：無向グラフ（辺が方向を持たないグラフ）
で表現されるグラフィカルモデルです．マルコフ確率場は，ベイジアンネットワークよりも比較的緩い束縛関係の表現に便利だそうです．

今日は，マルコフ確率場の話だけして，ベイジアンネットワークの話はしません．

マルコフ確率場の例
===============

ループがあると少し話がややこしいので，今日は次の図ような木構造を持つ無向グラフを考えてみます．
図中でどのノードが根であるかは，あまり意味がないので，明示していません（根とそれ以外のノードを区別して扱う必要がない）．

<center>![マルコフ確率場の例]({{site.baseurl}}/images/MRF-tree-example.png)</center>

この図中の $x\_i$ は確率変数であり（グラフィカルモデルでは，各ノードに確率変数が割り当てられます），
$f\_i$, $g\_{ij}$ はそれぞれ，ノードと辺の**エネルギー**を計算する関数で，
$f\_i(x\_i)$ は確率変数 $x\_i$ （の実現値）のエネルギー，$g\_{ij}(x\_i, x\_j)$ は $x\_i$ と $x\_j$ （の実現値）
を組合せたときのエネルギーを計算します（起こる確率の小さい組合せほどエネルギーが大きく，
起こる確率が大きい組合せほどエネルギーが小さい）．$f\_i$, $g\_{ij}$ を具体的にどんな関数にするかは，
あまり重要ではないので，この記事では特に決めません．グラフ上の全てのノードと辺のエネルギーの合計値は

$$
E(x\_1, x\_2, x\_3, x\_4)
= f\_1(x\_1) + f\_2(x\_2) + f\_3(x\_3) + f\_4(x\_4)
+ g\_{12}(x\_1, x\_2)+ g\_{13}(x\_1, x\_3)+ g\_{14}(x\_1, x\_4)
\\tag{1}
$$

となります（この $E$ もエネルギー関数と言います）．
マルコフ確率場は，統計力学と関わりが深く，「エネルギー」という用語も統計力学に関連したものです．
自然界では，エネルギーが大きい状態は不安定で，放っておくと，勝手に何らかの形でエネルギーを放出して，
エネルギーの低い状態になります（例えば，放熱による熱エネルギーの喪失など）．
なので，一般に，エネルギーの大きい状態は観測されるにくく，逆に，エネルギーの低い状態は観測される確率が高くなります．
ここで，$x\_1, \\dots, x\_4$ の観測確率（同時確率）は，次のように表され，高エネルギーが低確率，
低エネルギーが高確率に対応していることが理解できます．

$$
p(x\_1, x\_2, x\_3, x\_4) = \\frac{1}{Z} \\exp(-E(x\_1, x\_2, x\_3, x\_4)), \\quad
Z = \\sum\_{x\_1} \\dots \\sum\_{x\_4} \\exp(-E(x\_1, x\_2, x\_3, x\_4))
\\tag{2}
$$

この確率分布は**ボルツマン分布** (Boltzmann distribution) と呼ばれていて，
$\\exp(-E(x\_1, \\dots, x\_4))$ は**ポテンシャル関数** (potential function) と呼ばれます．
$Z$ は同時確率が $\\sum\_{x\_1} \\dots \\sum\_{x\_4} p(x\_1, \\dots, x\_4) = 1$
を満たすための規格化定数で重要な意味はありません．
式(1)を式(2)に代入して，$\\exp(a+b) = \\exp(a)\\exp(b)$ という性質を使うと，
次の式(3)が得られます（この式は後で使うので，今のうちに導出しておきます）．

\\begin{align*}
p(x\_1, x\_2, x\_3, x\_4)
& = \\frac{1}{Z} \\exp(- f\_1(x\_1) - \\dots - f\_4(x\_4) - g\_{12}(x\_1,x\_2) - \\dots - g\_{14}(x\_1,x\_4)) \\\\
& = \\frac{1}{Z} \\exp(-f\_1(x\_1)) \\dots \\exp(-f\_4(x\_4)) \\exp(-g\_{12}(x\_1,x\_2)) \\dots \\exp(-g\_{14}(x\_1,x\_4)) \\\\
& = \\frac{1}{Z} F\_1(x\_1) F\_2(x\_2) F\_3(x\_3) F\_4(x\_4) G\_{12}(x\_1,x\_2) G\_{13}(x\_1,x\_3) G\_{14}(x\_1,x\_4)
\\tag{3}
\\end{align*}

最後の式変形では，$F\_i(x\_i) = \\exp(-f\_i(x\_i))$,
$G\_{ij}(x\_i,x\_j) = \\exp(-g\_{ij}(x\_i,x\_j))$ とおきました（これらもポテンシャル関数と呼ばれます）．

物理が苦手で「エネルギーとかよくわからん！」という人は，
統計力学の用語であることを意識しすぎないほうが良いかもしれません．
統計力学との関連性を無視しても，マルコフ確率場を大まかに理解することはできます．
直感的に，エネルギー関数は単純に「データの観測され**にくさ**」を表していて，
同時確率そのものと大差ない情報だと思って構いません．
エネルギー関数は「観測され**やすさ**」の指標ではないので，確率とは逆の概念ですが，
両方とも「観測頻度」に関する情報なので，本質的には同種の情報です．
実際，同時確率の最大化とエネルギー関数の最小化は等価ですし，
大した違いはありません．

今回は，式(1)のようにエネルギー関数を決め打ちしましたが，解く問題によって色々な定義の仕方があります．
ただし，式(2)は，どんな問題を解く場合でも共通です（ただし，ノード数は 4 以外でも良いです）．


条件付き独立性
===========

先程，辺で繋がっていない確率変数は，条件付き独立であるという話をしました．
確率変数 $z$ の下で, $x$ が $y$ に対して **条件付き独立** (conditional independence) であるとは，

$$p(x | y,z) = p(x | z)$$

が成り立つことです．この式を利用すると，

$$p(x,y | z) = p(x | y,z) p(y | z) = p(x | z) p(y | z)$$

という式を導くことができます．マルコフ確率場の理解には，前者より後者の式の方が重要です．
この式は，$z$ が与えられた時に，$x$ と $y$ が独立であると言っていて，ただの独立性よりも少し制限されています．

マルコフ確率場において，ノード $i,j$ が辺で繋がれていないならば，
$x\_i$, $x\_j$ 以外の確率変数が与えられた時に，$x\_i$, $x\_j$ は条件付き独立になります．
試しに，先程のマルコフ確率場の例で，この性質が成り立つか確認してみます．
ノード3とノード4は辺で繋がっていないので，

$$
p(x\_3, x\_4 | x\_1, x\_2) = p(x\_3 | x\_1, x\_2) p(x\_4 | x\_1, x\_2)
\\tag{4}
$$

が成り立つはずです．式(4)の右辺は，

$$
p(x\_3, x\_4 | x\_1, x\_2)
= \\frac{p(x\_1, x\_2, x\_3, x\_4)}{p(x\_1, x\_2)}
= \\frac{p(x\_1, x\_2, x\_3, x\_4)}{\\sum\_{z\_3} \\sum\_{z\_4} p(x\_1, x\_2, z\_3, z\_4)}
= \\frac
{F\_3(x\_3) G\_{13}(x\_1,x\_3) F\_4(x\_4) G\_{14}(x\_1,x\_4)}
{\\sum\_{z\_3} \\sum\_{z\_4} F\_3(z\_3) G\_{13}(x\_1,z\_3) F\_4(z\_4) G\_{14}(x\_1,z\_4)}
$$

となり，式(4)の左辺は，

\\begin{align*}
p(x\_3 | x\_1, x\_2) p(x\_4 | x\_1, x\_2)
& = \\frac{p(x\_1, x\_2, x\_3)}{p(x\_1, x\_2)} \\cdot
\\frac{p(x\_1, x\_2, x\_4)}{p(x\_1, x\_2)} \\\\
& = \\frac{\\sum\_{z\_4} p(x\_1, x\_2, x\_3, z\_4)}{\\sum\_{z\_3} \\sum\_{z\_4} p(x\_1, x\_2, z\_3, z\_4)} \\cdot
\\frac{\\sum\_{z\_3} p(x\_1, x\_2, z\_3, x\_4)}{\\sum\_{z\_3} \\sum\_{z\_4} p(x\_1, x\_2, z\_3, z\_4)} \\\\
& =
\\frac{F\_3(x\_3) G\_{13}(x\_1,x\_3)}{\\sum\_{z\_3} F\_3(z\_3) G\_{13}(x\_1,z\_3)} \\cdot
\\frac{F\_4(x\_4) G\_{14}(x\_1,x\_4)}{\\sum\_{z\_4} F\_4(z\_4) G\_{14}(x\_1,z\_4)} \\\\
& = p(x\_3, x\_4 | x\_1, x\_2)
\\end{align*}

となり，条件付き独立であることが確認できました（他のノードについても，同様の手順で確認できます）．

ここで，なぜ $p(x\_3,x\_4) = p(x\_3, x\_4)$ のような（普通の）独立性ではなく，
あえて，条件付き独立性を扱うのか疑問に思う人がいるかもしれません．
そもそも，普通の独立性は成立しません．なぜなら，$x\_3$ と $x\_4$ は直接は繋がっていないものの，
$x\_1$ を介して間接的に繋がっていて，互いに影響し合っているため，
完全に独立にはなりません．
式(3)の条件付き独立性では，$x\_1$ と $x\_2$ を固定することで，
間接的な影響を排除した上で，$x\_3$ と $x\_4$ の独立性を考えているので，成立します．
つまり，直感的には，普通の独立性は「直接的・間接的影響を考慮した独立性」であり，
条件付き独立性は「直接的影響のみを考慮した独立性」ということになります．
普通の独立性は，2つの確率変数間を繋ぐパスが一切存在しない状況でのみ，成立します．


周辺確率の計算（積和アルゴリズム）
===========================

マルコフ確率場では，積和アルゴリズムという方法で周辺確率を効率的に求めることができます．
まずは，$x\_4$ の周辺確率を求めてみましょう．
周辺確率は，同時確率の和を取ればよいので，

$$
p\_4(x\_4)
= \\sum\_{x\_1} \\sum\_{x\_2} \\sum\_{x\_3} p(x\_1, x\_2, x\_3, x\_4)
$$

となります．この式に式(3)を代入して，因数分解すると，

$$
p\_4(x\_4)
= \\frac{1}{Z}
F\_4(x\_4)
\\left\\{
\\sum\_{x\_1} F\_1(x\_1) G\_{14}(x\_1,x\_4)
\\left( \\sum\_{x\_2} F\_2(x\_2) G\_{12}(x\_1,x\_2) \\right)
\\left( \\sum\_{x\_3} F\_3(x\_3) G\_{13}(x\_1,x\_3) \\right)
\\right\\}
\\tag{4}
$$

という式が得られます．ここで，ノード $j$ からノード $i$ への**メッセージ** (message) $\\mu\_{j \\to i}(x\_i)$
を次のように定義します．

\\begin{align*}
\\mu\_{2\\to1}(x\_1) & = \\sum\_{x\_2} F\_2(x\_2) G\_{12}(x\_1,x\_2) \\\\
\\mu\_{3\\to1}(x\_1) & = \\sum\_{x\_3} F\_3(x\_3) G\_{13}(x\_1,x\_3) \\\\
\\mu\_{1\\to4}(x\_4) & = \\sum\_{x\_1} F\_1(x\_1) G\_{14}(x\_1,x\_4) \\mu\_{2\\to1}(x\_1) \\mu\_{3\\to1}(x\_1)
\\end{align*}

すると，式(4)は次のように書けます．

$$
p\_4(x\_4) = \\frac{1}{Z} F\_4(x\_4) \\mu\_{1\\to4}(x\_4)
$$

先程定義したメッセージの式をよく見ると，子ノードから親ノードに向かってメッセージを伝搬しているように見えます．
図で書くと，次のようなイメージ．

<center>![マルコフ確率場におけるメッセージ伝搬]({{site.baseurl}}/images/MRF-tree-marginal-probability.png)</center>

基本的に，同様の方法で，他の確率変数に関する周辺確率も求めることができます．
ノード $i$ に接続されているノードの集合を $V\_i$ として，もう少し一般的に書くと，
メッセージと周辺確率は次のようになります．

$$
\\mu\_{j \\to i}(x\_i)
= \\sum\_{x\_j} F\_j(x\_j) G\_{ij}(x\_i,x\_j) \\prod\_{k \\in V\_j \\setminus \\{i\\}} \\mu\_{k \\to j}(x\_j),
\\qquad
p\_i(x\_i)
= \\frac{1}{Z} F\_i(x\_i) \\prod\_{j \\in V\_i} \\mu\_{j \\to i}(x\_i)
$$

$x\_i$ の周辺確率を求める場合は，ノード $i$ を根ノードだと思って，
葉から根に向かってメッセージを伝搬します．
このメッセージの伝搬は**メッセージパッシング** (message passing) と呼ばれています．
グラフの構造が木であれば，積和アルゴリズムで厳密な周辺確率を計算することができます．
木構造ではない場合は，グラフ中にループがあるので，メッセージが同じ所をぐるぐる回ってしまい，
（愚直に処理すると）メッセージパッシングが終わらなくなる可能性があります（グラフによっては収束することもあります）．
ループがある時は，工夫が必要ですが，この記事ではそこまで説明しません．


同時確率の最大化（max-sum アルゴリズム）
=================================

同時確率の最大化は，**max-sum アルゴリズム**，もしくは**Viterbi アルゴリズム**と呼ばれる方法で実現できます．
まず，max-sum アルゴリズムの前に，max-product アルゴリズムを導出します．
max-product アルゴリズムの導出は簡単で，同時確率を最大値を，式(4)と同じ手順で因数分解するだけです
（どのノードを根ノードと見るかで，因数分解の結果が変わってきますが，計算結果はt同じ値になります）．

\\begin{align*}
\\max\_{x\_1,\\dots,x\_4}[ p(x\_1, \\dots, x\_4) ]
& = \\max\_{x\_1} \\dots \\max\_{x\_4}[ p(x\_1, \\dots, x\_4)] \\\\
& = \\frac{1}{Z} \\max\_{x\_4} \\left[ F\_4(x\_4) \\max\_{x\_1} \\left[ F\_1(x\_1) G\_{14}(x\_1,x\_4)
\\max\_{x\_2} \\left[ F\_2(x\_2) G\_{12} \\right]
\\max\_{x\_3} \\left[ F\_3(x\_3) G\_{13} \\right]
\\right] \\right]
\\end{align*}

式(4)と見比べると，$\\sum\_{x\_i}$ を $\\max\_{x\_i}$ で置き換えただけであることが解ります．
なので，基本的に，積和アルゴリズムの和を最大値演算で置き換えれば，同様のメッセージパッシング規則を適用できます．

ただし，実用上，小さい値を持つ確率値をたくさん掛け算すると，アンダーフローを起こす可能性があります．
こういう時は，確率の対数値を使って計算することで，掛け算を足し算に置き換えることができます ($\\ln xy = \\ln x + \\ln y$)．
対数を取った時のメッセージパッシング規則は

$$
\\mu\_{j \\to i}(x\_i)
= \\max\_{x\_j} \\left[
\\ln F\_j(x\_j) + \\ln G\_{ij}(x\_i,x\_j) +
\\sum\_{k \\in V\_j \\setminus \\{i\\}} \\mu\_{k \\to j}(x\_j)
\\right\],
\\qquad
p^\\mathrm{max}
= \\frac{1}{Z} \\max\_{x\_r} \\left[ \\ln F\_r(x\_r) + \\sum\_{j \\in V\_r} \\mu\_{j \\to r}(x\_r) \\right]
$$

ただし，$x\_r$ は根ノードです．これが max-sum アルゴリズムです．
同時確率の最大値のみを計算すれば良い場合は，上のメッセージパッシング規則を愚直に実行すれば良いだけなので，とても簡単です．
ただし，同時確率の最大値を与える確率変数 $x\_i$ の具体値 $x\_i^\\mathrm{max}$ が知りたいこともよくあります．
この場合，上の式の計算に現れる最大値演算について，どの具体値が最大値を与えたのか（メッセージパッシングを行いつつ）記憶しておき，
$x\_1,\\dots,x\_4$ の具体値の組合せのうち，どれが最大になったのかを最後に計算する必要があります．

max-sum アルゴリズムにより，同時確率の最大値を与える確率変数の具体値を求める方法は，
ちょっとだけ複雑です（一度理解してしまえば，大したことはないのですが）．
ここでは，これまで扱ってきた木構造グラフではなく，次の図(a)のような，
一直線のグラフで max-sum アルゴリズムを解説します．
確率変数 $x\_1, x\_2, x\_3$ がそれぞれ離散値 A, B を取るとすると，組合せは，
AAA, AAB, ABA, ABB, BAA, BAB, BBA, BBB の8種類になります．
これらの具体値の組合せを，図(a)下のような**トレリス図** (trellis diagram) で表します．

<center>![max-sum アルゴリズム]({{site.baseurl}}/images/MRF-tree-viterbi.png)</center>

まず，図(b)のように，$x\_3$ から $x\_2$ に向かってメッセージパッシングを行うと，

- $x\_2 = A$ のときに最大値を与えた $x\_3$ の具体値（ここでは，B とします）と，
- $x\_2 = B$ のときに最大値を与えた $x\_3$ の具体値（ここでは，A とします）

が求まります．この2つをトレリス図に記録してきます．
同様に，図(c)のように，$x\_2$ から $x\_1$ に向かってメッセージパッシングを行うと，

- $x\_1 = A$ のときに最大値を与えた $x\_2$ の具体値（ここでは，B とします）と，
- $x\_1 = B$ のときに最大値を与えた $x\_2$ の具体値（ここでは，B とします）

が求まります．

- もしも，最終的に確立を最大化する具体値が $x\_1 = A$ ならば，根から葉に向かって，
  トレリス図のパスを辿る（**バックトラック**する; back-track）ことで，
  確率の最大値を与える具体値は $(x\_1,x\_2,x\_3) = (A,B,A)$ とわかります．
- 逆に，最終的に確立を最大化する具体値が $x\_1 = B$ ならば，同様にバックトラックして，
  $(x\_1,x\_2,x\_3) = (B,B,A)$ が得られます．

このように，それまでのメッセージパッシングでどの組合せが最大値を与えたのかを，
ノードごとに記録することで，同時確率の最大値を与える具体値の組合せを知ることができます．
木構造グラフについては，途中で枝分かれが入るだけで，基本的に同じ考え方が適用できます．

参考文献
=======

- [C. M. Bishop 著，元田浩／栗田多喜夫／樋口知之／松本裕治／村田昇 監訳，
  パターン認識と機械学習 下 - ベイズ理論による統計的予測，
  丸善出版，ISBN 978-4621061220，2007年12月出版．](http://ibisforest.org/index.php?PRML)
- [田中和之 著，ベイジアンネットワークの統計的推論の数理，
  コロナ社，ISBN 978-4-339-02441-8，2010年6月出版．](http://www.coronasha.co.jp/np/isbn/9784339024418/)
